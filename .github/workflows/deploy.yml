name: Deploy to Docker Hub

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Debug files
      run: |
        echo "=== DEBUG INFO ==="
        echo "📁 All files:"
        ls -la
        echo "📄 Dockerfile content:"
        cat Dockerfile
        echo "📄 index.html content:"
        cat index.html
        echo "=================="
    
    - name: Build Docker image
      run: |
        echo "🛠 Building Docker image..."
        docker build -t skpy1/ci-cd-app:latest -t skpy1/ci-cd-app:test-$(date +%s) .
        echo "✅ Build completed"
    
    - name: Login to Docker Hub
      run: |
        echo "🔐 Logging into Docker Hub..."
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "skpy1" --password-stdin
        echo "✅ Login result: $?"
    
    - name: Debug Docker images
      run: |
        echo "🐳 Available Docker images:"
        docker images | grep skpy1 || echo "❌ No skpy1 images found"
        echo "🔍 Docker Hub status:"
        docker system df
    
    - name: Push to Docker Hub
      run: |
        echo "🚀 Pushing to Docker Hub..."
        docker push skpy1/ci-cd-app:latest
        echo "✅ Push result: $?"
        
    - name: Verify push
      run: |
        echo "🔍 Verifying push..."
        docker pull skpy1/ci-cd-app:latest
        echo "✅ Pull result: $?"
    
    - name: Final check
      run: |
        echo "🎯 FINAL STATUS:"
        echo "Docker images built: $(docker images | grep skpy1 | wc -l)"
        echo "Pipeline completed at: $(date)"
