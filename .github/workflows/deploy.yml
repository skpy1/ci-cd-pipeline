name: Deploy to Docker Hub

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Debug files
      run: |
        echo "=== DEBUG INFO ==="
        echo "ğŸ“ All files:"
        ls -la
        echo "ğŸ“„ Dockerfile content:"
        cat Dockerfile
        echo "ğŸ“„ index.html content:"
        cat index.html
        echo "=================="
    
    - name: Build Docker image
      run: |
        echo "ğŸ›  Building Docker image..."
        docker build -t skpy1/ci-cd-app:latest -t skpy1/ci-cd-app:test-$(date +%s) .
        echo "âœ… Build completed"
    
    - name: Login to Docker Hub
      run: |
        echo "ğŸ” Logging into Docker Hub..."
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "skpy1" --password-stdin
        echo "âœ… Login result: $?"
    
    - name: Debug Docker images
      run: |
        echo "ğŸ³ Available Docker images:"
        docker images | grep skpy1 || echo "âŒ No skpy1 images found"
        echo "ğŸ” Docker Hub status:"
        docker system df
    
    - name: Push to Docker Hub
      run: |
        echo "ğŸš€ Pushing to Docker Hub..."
        docker push skpy1/ci-cd-app:latest
        echo "âœ… Push result: $?"
        
    - name: Verify push
      run: |
        echo "ğŸ” Verifying push..."
        docker pull skpy1/ci-cd-app:latest
        echo "âœ… Pull result: $?"
    
    - name: Final check
      run: |
        echo "ğŸ¯ FINAL STATUS:"
        echo "Docker images built: $(docker images | grep skpy1 | wc -l)"
        echo "Pipeline completed at: $(date)"
